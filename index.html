<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imagem com Grid</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        #container {
            position: relative;
            width: 100vw; /* Largura igual à largura do viewport */
            height: 100vh; /* Altura igual à altura do viewport */
            display: flex;
            justify-content: center; /* Centraliza horizontalmente */
            align-items: center; /* Centraliza verticalmente */
            overflow: hidden;
        }
        #grid {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0.5;
        }
        #image {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Mantém a proporção da imagem e a ajusta ao container */
            touch-action: none; /* Desativa a ação padrão de toque para a imagem */
        }
    </style>
</head>
<body>
    <input type="file" id="imageInput" accept="image/*">
    <label for="settings">Configurações: </label>
    <input type="range" id="settings" min="1" max="500" step="1" value="10">
    <label for="alpha">Alpha: </label>
    <input type="range" id="alpha" min="0" max="1" step="0.01" value="0.5">
    <label for="lineColor">Cor: </label>
    <input type="color" id="lineColor" value="#000000">
    <button id="saveButton" style="display: none;">Salvar</button>

    <div id="container">
        <canvas id="grid"></canvas>
        <img id="image" src="" alt="Imagem" style="display: none;">
    </div>
    

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        const container = document.getElementById('container');
        const image = document.getElementById('image');
        const gridCanvas = document.getElementById('grid');
        const settingsInput = document.getElementById('settings');
        const alphaInput = document.getElementById('alpha');
        const lineColorInput = document.getElementById('lineColor');
        const imageInput = document.getElementById('imageInput');
        const resizeHandle = document.getElementById('resize-handle');
        const saveButton = document.getElementById('saveButton');


        let gridSize = parseInt(settingsInput.value);
        let gridAlpha = parseFloat(alphaInput.value);
        let lineColor = lineColorInput.value;
        let resizing = false;

        const ctx = gridCanvas.getContext('2d');

        // Carrega a imagem quando o usuário seleciona uma
        imageInput.addEventListener('change', (e) => {
            const selectedImage = e.target.files[0];
            if (selectedImage) {
                const imageURL = URL.createObjectURL(selectedImage);
                image.src = imageURL;
                image.style.display = 'block'; // Exibe o container
                container.style.display = 'block'; // Exibe o container
                saveButton.style.display = 'block'; // Exibe o botão de salvar
                drawGrid();
            }
        });

        // Redesenha o grid com base nos valores atuais
        function drawGrid() {
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            gridCanvas.width = containerWidth;
            gridCanvas.height = containerHeight;

            const minSize = Math.min(containerWidth, containerHeight);
            const cellSize = minSize / gridSize;

            // Calcula o deslocamento para centralizar o grid em relação à imagem
            const offsetX = (containerWidth - minSize) / 2;
            const offsetY = (containerHeight - minSize) / 2;

            ctx.clearRect(0, 0, containerWidth, containerHeight);
            ctx.strokeStyle = `rgba(${hexToRgb(lineColor).join(', ')}, ${gridAlpha})`;
            ctx.lineWidth = 1;

            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const x = offsetX + i * cellSize;
                    const y = offsetY + j * cellSize;
                    ctx.strokeRect(x, y, cellSize, cellSize);
                }
            }
        }

        // Atualiza o grid quando o controle deslizante é movido
        settingsInput.addEventListener('input', () => {
            gridSize = parseInt(settingsInput.value);
            drawGrid();
        });

        // Atualiza o grid quando o controle deslizante alpha é movido
        alphaInput.addEventListener('input', () => {
            gridAlpha = parseFloat(alphaInput.value);
            drawGrid();
        });

        // Atualiza a cor das linhas do grid quando o seletor de cor é alterado
        lineColorInput.addEventListener('input', () => {
            lineColor = lineColorInput.value;
            drawGrid();
        });

        // Rotação da imagem com toque (touch)
        let touchStartAngle = 0;
        let isTouching = false;

        container.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                touchStartAngle = angle;
                isTouching = true;
            }
        });

        container.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1 && isTouching) {
                const touch = e.touches[0];
                const deltaX = touch.clientX - e.targetTouches[0].clientX;
                const deltaY = touch.clientY - e.targetTouches[0].clientY;
                angle = touchStartAngle + (Math.atan2(deltaY, deltaX) * 180) / Math.PI;
                image.style.transform = `rotate(${angle}deg)`;
                drawGrid();
            }
        });

        container.addEventListener('touchend', () => {
            isTouching = false;
        });

        // Salva a imagem + grid como um arquivo JPG
        saveButton.addEventListener('click', () => {
            html2canvas(container).then((canvas) => {
                const image = canvas.toDataURL('image/jpeg');
                const a = document.createElement('a');
                a.href = image;
                a.download = 'imagem_com_grid.jpg';
                a.click();
            });
        });

        // Função para converter uma cor hexadecimal em um array de valores RGB
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return [r, g, b];
        }
    </script>
</body>
</html>
